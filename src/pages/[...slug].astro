---
import { getCollection, getEntry, type CollectionEntry } from "astro:content";
import Layout from "@layouts/BaseLayout.astro";
import TrackView from "@components/track/TrackView.vue";
import authors from "src/authors.json";
import {journeyTypes} from "../utils/types";
import JourneyType from "../components/TypeIcon.astro";
import {dateFormatter, getPreviewAlt} from "../utils/general";
import {getImage} from "astro:assets";
import JourneyContent from "@components/JourneyContent.astro";
import Button from "@components/Button.astro";
import { Icon } from "astro-icon/components";
import TitleNav from "@components/TitlesNav.astro";

export async function getStaticPaths() {
    const posts: CollectionEntry<'posts'>[] = await getCollection("posts");

    return posts.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

interface Props {
    entry: CollectionEntry<"posts">;
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();

const geoJson = await getEntry(entry.data.gpx);
const author = authors[entry.data.author];
const journeyType = journeyTypes[entry.data.type];

const jsDate: Date = entry.data.date;
const machineDate = jsDate.toISOString();
const humanDate = dateFormatter(jsDate, Astro.currentLocale);

const ogImage = await getImage({
    src: entry.data.image,
    width: 1200,
    height: 630,
    format: "webp",
});

const ogAlt = getPreviewAlt(entry);
---

<Layout title={entry.data.title}>
    <Fragment slot="meta">
        <meta property="og:type" content="article" />
        <meta property="article:section" content="travel"/>
        <meta property="article:section" content={entry.data.type} />
        <meta property="article:tag" content="travel" />
        <meta property="article:tag" content={entry.data.type} />
        
        <meta name="date" content={machineDate} />
        <meta property="article:published_time" content={machineDate} />
        
        <meta name="author" content={author.name}/>
        <meta name="fediverse:creator" content={author.fediverse}/>
        <meta property="article:author" content={author.name}/>
        
        <meta name="description" content={entry.data.description} />
        <meta property="og:description" content={entry.data.description} />
        
        <meta property="og:image" content={ogImage.src}/>
        <meta property="og:image:width" content={`${ogImage.options.width}`}/>
        <meta property="og:image:height" content={`${ogImage.options.height}`}/>
        <meta property="og:image:format" content={ogImage.options.format}/>
        <meta property="og:image:alt" content={ogAlt}/>
    </Fragment>

    <div class="w-full bg-bg-2 dark:bg-bg-2-dark">
        <section class="w-full m-auto pt-10 pb-4">
            <h1 class="font-bold text-4xl sm:text-5xl0 mt-8 md:mt-0 mb-4 text-center">{entry.data.title}</h1>
            <div class="text-center text-2xl sm:text-3xl mb-8 flex align-baseline gap-2 justify-center">
                {(<JourneyType type={journeyType} />)}
                <span>·</span>
                <time datetime={jsDate.toISOString()}>{humanDate}</time>
            </div>
        </section>

        <div class="w-full px-5 md:px-0 mx-auto flex bg-bg dark:bg-bg-dark">
            <div class="grow mx-auto w-full">
                <div class="bg-bg-2 dark:bg-bg-2-dark">
                    <div class="max-w-7xl mx-auto">
                        <TrackView client:only="vue" geoJson={geoJson.data}/>
                    </div>
                </div>

                <JourneyContent>
                    <Content />
                </JourneyContent>
            </div>

            <nav class="w-max hidden md:block sticky top-0 h-screen p-5 pt-10 pr-12 bg-bg-2 bg-bg-2-dark">
                <TitleNav headings={headings} />

                <Button href={Astro.url.href}>
                    <Icon name="mdi:chevron-up" slot="icon"/>
                    Zurück nach oben
                </Button>

                <Button href={import.meta.env.BASE_URL}>
                    <Icon name="mdi:chevron-left" slot="icon"/>
                    Zurück zur Übersicht
                </Button>
            </nav>
        </div>
    </div>
</Layout>
