---
import { getCollection, getEntry, type CollectionEntry } from "astro:content";
import Layout from "@layouts/BaseLayout.astro";
import TrackView from "@components/track/TrackView.vue";
import authors from "src/authors.json";
import {journeyTypes} from "../utils/types";
import JourneyType from "../components/TypeIcon.astro";
import {dateFormatter} from "../utils/general";
import "@styles/markdown.css";
import {getImage} from "astro:assets";

export async function getStaticPaths() {
    const posts: CollectionEntry<'posts'>[] = await getCollection("posts");

    return posts.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

interface Props {
    entry: CollectionEntry<"posts">;
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const geoJson = (await getEntry("gpx", entry.data.gpx)) as CollectionEntry<"gpx">;
const author = authors[entry.data.author];

const jsDate: Date = entry.data.date;
const machineDate = jsDate.toDateString();
const humanDate = dateFormatter(jsDate);

const ogImage = await getImage({
    src: entry.data.image,
    width: 1200,
    height: 630,
    format: "webp",
});
---

<Layout title={entry.data.title}>
    <Fragment slot="meta">
        <meta name="og:type" content="article" />
        <meta name="og:article:section" content="travel"/>
        <meta name="og:article:section" content={entry.data.type} />
        <meta name="og:article:tag" content="travel" />
        <meta name="og:article:tag" content={entry.data.type} />
        <meta name="date" content={machineDate} />
        <meta name="og:article:published_time" content={machineDate} />
        <meta name="author" content={author.name}/>
        <meta name="fediverse:creator" content={author.fediverse}/>
        <meta name="og:article:author" content={author.name}/>
        <meta name="og:image" content={ogImage.src}/>
        <meta name="og:image:width" content={`${ogImage.options.width}`}/>
        <meta name="og:image:height" content={`${ogImage.options.height}`}/>
        <meta name="og:image:format" content={ogImage.options.format}/>
    </Fragment>

    <section>
        <h1 class="font-bold text-4xl sm:text-5xl mb-4 text-center">{entry.data.title}</h1>
        <div class="text-center text-2xl sm:text-3xl mb-8 flex align-baseline gap-2 justify-center">
            {(<JourneyType type={journeyTypes[entry.data.type]} />)}
            <span>·</span>
            <time datetime={jsDate.toISOString()}>{humanDate}</time>
        </div>
    </section>
    
    <div class="w-full px-5 sm:px-10">
        <TrackView client:only="vue" geoJson={geoJson.data.data}/>
    </div>
    
    <article class="max-w-3xl mx-5 sm:mx-10">
        <Content />
    </article>
    
    <a href={import.meta.env.BASE_URL} class="block px-2 py-1 
        border-2 border-orange-800 dark:border-orange-200 rounded-lg mt-5 mb-10
        hover:bg-orange-900 hover:text-orange-100 hover:dark:bg-orange-200 hover:dark:text-orange-900
        ">
        Zurück zur Übersicht
    </a>
</Layout>
